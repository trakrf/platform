# Database Infrastructure Task Runner
set fallback := true

# Start TimescaleDB container
up:
    docker compose up -d timescaledb
    @echo "⏳ Waiting for database to be ready..."
    @for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15; do \
        if docker compose exec timescaledb pg_isready -U postgres > /dev/null 2>&1; then \
            echo "✅ Database is ready"; \
            exit 0; \
        fi; \
        sleep 2; \
    done; \
    echo "⚠️  Database is starting but not ready yet. Run 'just database status' to check."

# Stop database container
down:
    docker compose down

# Show database logs
logs:
    docker compose logs -f timescaledb

# Interactive psql shell
psql:
    docker compose exec -it timescaledb psql -U postgres

# Alias for psql
alias shell := psql

# Reset database (WARNING: deletes all data)
reset:
    @echo "⚠️  This will delete all data. Press Ctrl+C to cancel."
    @sleep 3
    docker compose down -v
    docker compose up -d timescaledb
    @echo "⏳ Waiting for database to initialize..."
    @sleep 10
    @echo "✅ Database reset complete"

# Check database status
status:
    @docker compose ps timescaledb
    @docker compose exec timescaledb pg_isready -U postgres && echo "✅ Database is ready" || echo "❌ Database not ready"
