# Backend Task Runner (TrakRF Platform)
# Uses fallback to inherit shared recipes from root justfile
set fallback := true

# Get database URLs from environment (loaded by direnv from .env.local)
pg_url_local := env("PG_URL_LOCAL", "")
pg_url_cloud := env("PG_URL_CLOUD", "")

# List all available recipes
default:
    @just --list

# Start Go development server with hot reload (backend on host â†’ postgres in docker)
dev:
    @echo "ğŸš€ Backend on host â†’ postgres in docker (localhost:5432)"
    @env PG_URL="{{pg_url_local}}" air

# Cloud development with hot reload (backend on host â†’ postgres in cloud)
dev-cloud:
    @echo "â˜ï¸  Backend on host â†’ cloud postgres"
    @env PG_URL="{{pg_url_cloud}}" air

# Run without hot reload (for debugging)
dev-no-reload:
    @echo "ğŸš€ Backend on host â†’ postgres in docker (no hot reload)"
    @go build -o ./tmp/main . && env PG_URL="{{pg_url_local}}" ./tmp/main

# Alias for consistency
run: dev

# Lint Go code (formatting + static analysis)
lint:
    go fmt ./...
    go vet ./...

# Run backend tests with verbose output
test:
    go test -v ./...

# Run tests with race detection
test-race:
    go test -race ./...

# Run tests with coverage report
test-coverage:
    go test -cover ./...

# Resync vendor directory with go.mod
vendor:
    go mod vendor

# Build backend binary with version injection
build:
    go build -ldflags "-X main.version=0.1.0-dev" -o bin/trakrf .

# Generate Swagger API documentation
swagger:
    @echo "ğŸ“š Generating Swagger documentation..."
    swag init -g main.go --parseDependency --parseInternal
    @echo "âœ… Swagger docs generated at docs/"
    @echo "ğŸ“– View at: http://localhost:8080/swagger/index.html"

# Smoke test - verifies binary starts without panic (uses PG_URL_LOCAL for host â†’ docker)
smoke-test:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "ğŸ”¥ Running smoke test..."
    just build
    echo "Starting server with 5s timeout..."
    export PG_URL="{{pg_url_local}}"
    timeout 5s ./bin/trakrf > /tmp/trakrf-smoke.log 2>&1 & SERVER_PID=$!
    sleep 2
    echo "Testing /healthz endpoint..."
    if curl -f http://localhost:8080/healthz > /dev/null 2>&1; then
    echo "âœ… Smoke test passed"
    kill $SERVER_PID 2>/dev/null || true
    else
    echo "âŒ Smoke test failed"
    cat /tmp/trakrf-smoke.log
    kill $SERVER_PID 2>/dev/null || true
    exit 1
    fi

# Run all backend validation checks
validate: lint test build smoke-test

# Shell access
shell:
    docker compose exec backend sh

# ============================================================================
# Database Migrations
# ============================================================================

# Run database migrations
migrate:
    @echo "ğŸ”„ Running database migrations..."
    docker compose exec backend sh -c 'migrate -path /app/migrations -database "$PG_URL" up'
    @echo "âœ… Migrations complete"

# Alias for consistency
migrate-up: migrate

# Roll back last migration
migrate-down:
    @echo "âª Rolling back last migration..."
    docker compose exec backend sh -c 'migrate -path /app/migrations -database "$PG_URL" down 1'
    @echo "âœ… Rollback complete"

# Show current migration version
migrate-status:
    @echo "ğŸ“Š Migration status:"
    docker compose exec backend sh -c 'migrate -path /app/migrations -database "$PG_URL" version'

# Create new migration file
migrate-create name:
    @echo "ğŸ“ Creating new migration: {{name}}"
    docker compose exec backend sh -c 'migrate create -ext sql -dir /app/migrations -seq {{name}}'

# Force migration to specific version (dangerous)
migrate-force version:
    @echo "âš ï¸  Forcing migration version to {{version}}"
    docker compose exec backend sh -c 'migrate -path /app/migrations -database "$PG_URL" force {{version}}'
