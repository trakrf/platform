# Backend Task Runner (TrakRF Platform)
# Uses fallback to inherit shared recipes from root justfile
set fallback := true

# List all available recipes
default:
    @just --list

# Start Go development server (local mode: backend on host → postgres in docker)
dev:
    @echo "🚀 Backend on host → postgres in docker (localhost:5432)"
    @if [ -z "$$PG_URL_LOCAL" ]; then \
        echo "⚠️  PG_URL_LOCAL not set - using PG_URL"; \
        go run .; \
    else \
        PG_URL="$$PG_URL_LOCAL" go run .; \
    fi

# Cloud development (backend on host → postgres in cloud)
dev-cloud:
    @echo "☁️  Backend on host → cloud postgres"
    @if [ -z "$$PG_URL_CLOUD" ]; then \
        echo "❌ PG_URL_CLOUD not set in .env.local"; \
        exit 1; \
    fi
    PG_URL="$$PG_URL_CLOUD" go run .

# Alias for consistency
run: dev

# Lint Go code (formatting + static analysis)
lint:
    go fmt ./...
    go vet ./...

# Run backend tests with verbose output
test:
    go test -v ./...

# Run tests with race detection
test-race:
    go test -race ./...

# Run tests with coverage report
test-coverage:
    go test -cover ./...

# Build backend binary with version injection
build:
    go build -ldflags "-X main.version=0.1.0-dev" -o bin/trakrf .

# Smoke test - verifies binary starts without panic (uses PG_URL_LOCAL for host → docker)
smoke-test:
    @echo "🔥 Running smoke test..."
    @just build
    @echo "Starting server with 5s timeout..."
    @if [ -n "$$PG_URL_LOCAL" ]; then \
        PG_URL="$$PG_URL_LOCAL" timeout 5s ./bin/trakrf > /tmp/trakrf-smoke.log 2>&1 & SERVER_PID=$$! ; \
    else \
        timeout 5s ./bin/trakrf > /tmp/trakrf-smoke.log 2>&1 & SERVER_PID=$$! ; \
    fi ; \
    sleep 2 ; \
    echo "Testing /healthz endpoint..." ; \
    curl -f http://localhost:8080/healthz > /dev/null 2>&1 || (echo "❌ Smoke test failed" && cat /tmp/trakrf-smoke.log && exit 1) ; \
    kill $$SERVER_PID 2>/dev/null || true ; \
    echo "✅ Smoke test passed"

# Run all backend validation checks
validate: lint test build smoke-test

# Shell access
shell:
    docker compose exec backend sh
